name: 'Cleanup Terraform PR Comments and Labels'
description: 'Delete no-changes comments and labels for a specific Terraform environment'

inputs:
  environment:
    description: 'Environment name (dev or prod)'
    required: true
  prNumber:
    description: 'Pull request number'
    required: true
  githubToken:
    description: 'GitHub token for API access'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Delete no-changes comments
      env:
        GH_TOKEN: ${{ inputs.githubToken }}
      shell: bash
      run: |
        # Delete comments containing "No changes" for this environment
        echo "Looking for comments containing 'No changes' and '${{ inputs.environment }}/'"

        # Get comment URLs and extract comment IDs
        echo "Attempting to delete comments..."
        gh pr view ${{ inputs.prNumber }} --json comments --jq -r '.comments[] | select(.body | contains("No changes") and contains("${{ inputs.environment }}/")) | .url' | \
          while read -r comment_url; do
            if [ -n "$comment_url" ]; then
              # Extract comment ID from URL (format: https://github.com/owner/repo/pull/123#issuecomment-456789)
              comment_id=$(echo "$comment_url" | grep -oP 'issuecomment-\K\d+')

              if [ -n "$comment_id" ]; then
                echo "Deleting comment ID: $comment_id (from URL: $comment_url)"
                gh api -X DELETE "/repos/${{ github.repository }}/issues/comments/$comment_id" || echo "Failed to delete comment $comment_id"
              else
                echo "Could not extract comment ID from URL: $comment_url"
              fi
            fi
          done

    - name: Remove no-changes labels
      env:
        GH_TOKEN: ${{ inputs.githubToken }}
      shell: bash
      run: |
        # Remove labels with /no-changes suffix for this environment
        gh pr view ${{ inputs.prNumber }} --json labels --jq '.labels[].name' | \
          grep "^${{ inputs.environment }}/.*no-changes$" | \
          xargs -I {} gh pr edit ${{ inputs.prNumber }} --remove-label "{}" || true
