# EduQuest Document Overview

[![codecov](https://codecov.io/gh/tqer39/edu-quest/graph/badge.svg)](https://codecov.io/gh/tqer39/edu-quest)
[![D1 Migrations (Dev)](https://github.com/tqer39/edu-quest/actions/workflows/d1-migrations-dev.yml/badge.svg)](https://github.com/tqer39/edu-quest/actions/workflows/d1-migrations-dev.yml)
[![D1 Migrations (Prod)](https://github.com/tqer39/edu-quest/actions/workflows/d1-migrations-prod.yml/badge.svg)](https://github.com/tqer39/edu-quest/actions/workflows/d1-migrations-prod.yml)
[![Terraform (Dev)](https://github.com/tqer39/edu-quest/actions/workflows/terraform-dev.yml/badge.svg)](https://github.com/tqer39/edu-quest/actions/workflows/terraform-dev.yml)
[![Terraform (Prod)](https://github.com/tqer39/edu-quest/actions/workflows/terraform-prod.yml/badge.svg)](https://github.com/tqer39/edu-quest/actions/workflows/terraform-prod.yml)

EduQuest is a learning platform for elementary school students that provides various educational content through specialized "Quest" modules. Built with Hono for SSR on Cloudflare Workers, it features a shared domain logic managed in a monorepo with pnpm workspaces.

## Technology Stack

### Application & Language

<table border="0">
  <tr>
    <td align="center">
      <a href="https://hono.dev/" target="_blank" rel="noopener noreferrer">
        <img src="https://hono.dev/images/logo.png" alt="Hono logo" width="60" height="60" />
        <br /><sub><b>Hono</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/typescript/typescript-original.svg" alt="TypeScript logo" width="60" height="60" />
        <br /><sub><b>TypeScript</b></sub>
      </a>
    </td>
  </tr>
</table>

### Testing & Quality

<table border="0">
  <tr>
    <td align="center">
      <a href="https://vitest.dev/" target="_blank" rel="noopener noreferrer">
        <img src="https://vitest.dev/logo.svg" alt="Vitest logo" width="60" height="60" />
        <br /><sub><b>Vitest</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://www.cypress.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/cypressio/cypressio-original.svg" alt="Cypress logo" width="60" height="60" />
        <br /><sub><b>Cypress</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://about.codecov.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://avatars.githubusercontent.com/u/8226205?s=200&v=4" alt="Codecov logo" width="60" height="60" />
        <br /><sub><b>Codecov</b></sub>
      </a>
    </td>
  </tr>
</table>

### Cloud & Infrastructure

<table border="0">
  <tr>
    <td align="center">
      <a href="https://www.cloudflare.com/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/cloudflare/cloudflare-original.svg" alt="Cloudflare logo" width="60" height="60" />
        <br /><sub><b>Cloudflare</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://aws.amazon.com/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/amazonwebservices/amazonwebservices-original-wordmark.svg" alt="AWS logo" width="60" height="60" />
        <br /><sub><b>AWS</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://cloud.google.com/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/googlecloud/googlecloud-original.svg" alt="Google Cloud logo" width="60" height="60" />
        <br /><sub><b>Google Cloud</b></sub>
      </a>
    </td>
  </tr>
</table>

### Developer Productivity

<table border="0">
  <tr>
    <td align="center">
      <a href="https://www.anthropic.com/claude/code" target="_blank" rel="noopener noreferrer">
        <img src="https://claude.ai/images/claude_app_icon.png" alt="Claude Code logo" width="60" height="60" />
        <br /><sub><b>Claude Code</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://openai.com/blog/openai-codex" target="_blank" rel="noopener noreferrer">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg" alt="OpenAI logo" width="60" height="60" />
        <br /><sub><b>OpenAI</b></sub>
      </a>
    </td>
  </tr>
</table>

### Infrastructure as Code (IaC) & Development Tools

<table border="0">
  <tr>
    <td align="center">
      <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/terraform/terraform-original.svg" alt="Terraform logo" width="60" height="60" />
        <br /><sub><b>Terraform</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://aquasecurity.github.io/tfsec/" target="_blank" rel="noopener noreferrer">
        <img src="https://aquasecurity.github.io/tfsec/latest/imgs/logo.png" alt="tfsec logo" width="60" height="60" />
        <br /><sub><b>tfsec</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://brew.sh/" target="_blank" rel="noopener noreferrer">
        <img src="https://brew.sh/assets/img/homebrew.svg" alt="Homebrew logo" width="60" height="60" />
        <br /><sub><b>Homebrew</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://mise.jdx.dev/" target="_blank" rel="noopener noreferrer">
        <img src="https://mise.jdx.dev/logo.svg" alt="mise logo" width="60" height="60" />
        <br /><sub><b>mise</b></sub>
      </a>
    </td>
  </tr>
  <tr>
    <td align="center">
      <a href="https://just.systems/" target="_blank" rel="noopener noreferrer">
        <img src="https://raw.githubusercontent.com/casey/just/master/icon.png" alt="just logo" width="60" height="60" />
        <br /><sub><b>just</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://github.com/" target="_blank" rel="noopener noreferrer">
        <img src="https://github.githubassets.com/assets/GitHub-Mark-ea2971cee799.png" alt="GitHub logo" width="60" height="60" />
        <br /><sub><b>GitHub</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://prettier.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://prettier.io/icon.png" alt="Prettier logo" width="60" height="60" />
        <br /><sub><b>Prettier</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://pre-commit.com/" target="_blank" rel="noopener noreferrer">
        <img src="https://pre-commit.com/logo.svg" alt="pre-commit logo" width="60" height="60" />
        <br /><sub><b>pre-commit</b></sub>
      </a>
    </td>
  </tr>
  <tr>
    <td align="center">
      <a href="https://github.com/dyoshikawa/rulesync" target="_blank" rel="noopener noreferrer">
        <img src="https://avatars.githubusercontent.com/u/19943347?v=4" alt="rulesync logo" width="60" height="60" />
        <br /><sub><b>rulesync</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://editorconfig.org/" target="_blank" rel="noopener noreferrer">
        <img src="https://editorconfig.org/logo.png" alt="EditorConfig logo" width="60" height="60" />
        <br /><sub><b>EditorConfig</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://pnpm.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://pnpm.io/img/pnpm-no-name-with-frame.svg" alt="pnpm logo" width="60" height="60" />
        <br /><sub><b>pnpm</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://yamllint.readthedocs.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://avatars.githubusercontent.com/u/102422558?s=200&v=4" alt="yamllint logo" width="60" height="60" />
        <br /><sub><b>yamllint</b></sub>
      </a>
    </td>
  </tr>
  <tr>
    <td align="center">
      <a href="https://cspell.org/" target="_blank" rel="noopener noreferrer">
        <img src="https://avatars.githubusercontent.com/u/50543896?s=200&v=4" alt="cspell logo" width="60" height="60" />
        <br /><sub><b>cspell</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://textlint.github.io/" target="_blank" rel="noopener noreferrer">
        <img src="https://textlint.org/media/logo/spaced/textlint-logo.png" alt="textlint logo" width="60" height="60" />
        <br /><sub><b>textlint</b></sub>
      </a>
    </td>
    <td align="center">
      <a href="https://www.toptal.com/developers/gitignore/" target="_blank" rel="noopener noreferrer">
        <img src="https://github.com/toptal/gitignore.io/raw/master/Public/img/gitignoreio.svg" alt="gitignore.io logo" width="60" height="60" />
        <br /><sub><b>gitignore.io</b></sub>
      </a>
    </td>
  </tr>
</table>

## Quest Modules

- **MathQuest** (`/math`): Arithmetic practice with grade-level presets and themed exercises. Users can select calculation types, toggle settings (sound effects, intermediate steps), and practice with a keypad UI.
- **KanjiQuest** (`/kanji`): Kanji learning organized by grade level (Coming Soon)
- **GameQuest** (`/game`): Brain-training mini games for pattern recognition, spatial reasoning, and memory (Coming Soon)
- **ClockQuest** (`/clock`): Time-reading practice with analog and digital clocks (Coming Soon)

The platform features an EduQuest hub page (`/`) where users can navigate to each Quest module. Question generation and grading are handled by `@edu-quest/domain` and are reused by the API layer (`/apis/quiz`).

## Quick Start

### Prerequisites

The repository uses the following tools:

- **Homebrew**: Manages system-level development tools for macOS/Linux.
- **mise**: Manages versions of the execution environment, such as Node.js, pnpm, and Wrangler.
- **just**: A task runner for bundling setup and linting commands.
- **pnpm**: Manages the JavaScript/TypeScript workspace.

### Setup

**Important**: Before running `make bootstrap`, you need to complete the following steps:

#### 1. Set up Cloudflare credentials

```bash
# Add Cloudflare credentials (required before make bootstrap)
cf-vault add edu-quest
cf-vault list
```

#### 2. Initialize Terraform Bootstrap

Set up Cloudflare resources (D1, KV, Turnstile, etc.) for the development environment:

```bash
just tf -chdir=dev/bootstrap init -reconfigure
just tf -chdir=dev/bootstrap validate
just tf -chdir=dev/bootstrap plan
just tf -chdir=dev/bootstrap apply -auto-approve
```

#### 3. Proceed with the standard setup

```bash
# 1. Install Homebrew (macOS/Linux)
make bootstrap

# 2. Set up dependent tools and npm packages together
# This also installs Cypress binary automatically
just setup
```

If you already have Homebrew, run `brew bundle install` before `just setup`.

**Note:** The `just setup` command automatically installs:

- mise tools (Node.js, pnpm, etc.)
- pnpm (if not already installed)
- All npm dependencies
- Cypress binary for E2E testing

### Frequently Used Commands

```bash
# List all available just tasks
just help

# Run code quality checks (biome, cspell, vitest, etc.)
just lint

# Apply automatic formatting
just fix

# Clear the pre-commit cache
just clean

# Update runtimes and CLIs
just update-brew
just update
just update-hooks

# Check mise status
just status

# Run E2E tests with Cypress (headless)
just e2e

# Open Cypress test runner (interactive)
just e2e-open
```

## Testing

### Unit Tests

The project uses Vitest for unit testing:

```bash
# Run all unit tests
pnpm test

# Run unit tests in watch mode
pnpm test:watch

# Generate coverage report
pnpm test:coverage
```

### E2E Tests

The project uses Cypress for end-to-end testing to verify screen transitions and user flows.

#### Running E2E Tests

##### Option 1: Manual (recommended for development)

```bash
# 1. Start the Cloudflare Workers dev server in a separate terminal
pnpm dev:edge
# This starts the server on http://localhost:8788

# 2. Run E2E tests in headless mode
just e2e

# OR open Cypress test runner (interactive mode)
just e2e-open
```

##### Option 2: Automatic (for CI or quick testing)

```bash
# Automatically start dev server and run E2E tests
just e2e-ci
```

This command will:

1. Start the Cloudflare Workers dev server in the background
2. Wait for the server to be ready (max 30 seconds)
3. Run all E2E tests
4. Automatically shut down the server when done

**Important Notes:**

- **E2E tests MUST run against `@edu-quest/edge` (Cloudflare Workers), NOT `@edu-quest/web`**
- `@edu-quest/web` is a placeholder Node.js server without actual application routes
- All application routes (/, /math, /math/start, /math/play, etc.) exist only in `@edu-quest/edge`
- The `just e2e` and `just e2e-open` commands check if the server is running on `http://localhost:8788`
- **Always use `pnpm dev:edge` to start the server for E2E testing**

**E2E Test Coverage:**

- Navigation flows between pages (Home → MathQuest → Start → Play → Results)
- ClockQuest navigation
- Backward navigation (browser back button)
- Legacy URL redirects (`/start` → `/math/start`, `/play` → `/math/play`)

#### CI/CD Integration

E2E tests run automatically in GitHub Actions on:

- Push to `main` branch
- Pull request creation/updates

The CI workflow (`.github/workflows/e2e.yml`) performs the following:

1. Installs `just` command runner
2. Sets up mise (Node.js, pnpm, etc.)
3. Installs pnpm dependencies
4. Installs Cypress binary
5. Builds required packages (`@edu-quest/domain`, `@edu-quest/app`)
6. Runs `just e2e-ci` (automatic server management)
7. Uploads screenshots and videos on failure

#### Viewing Test Failure Screenshots

When E2E tests fail in CI:

1. Go to the failed workflow run in GitHub Actions
2. Scroll to the bottom of the page
3. Download the `cypress-screenshots` artifact (if available)
4. Download the `cypress-videos` artifact (if video recording is enabled)
5. Review the screenshots/videos to diagnose the issue

Screenshot files are organized by test file and test name:

```text
cypress/screenshots/
├── math-quest-flow.cy.ts/
│   └── MathQuest Flow -- Start Configuration Page -- should load (failed).png
└── navigation.cy.ts/
    └── EduQuest Navigation -- Home Page -- should load (failed).png
```

## Repository Structure

- `apps/edge`: The Hono SSR app that runs on Cloudflare Workers. It contains the start/play screens in `routes/pages` and the question generation/grading API in `routes/apis/quiz.ts`.
- `apps/api` / `apps/web`: A Node server and web front-end for local development. Used for validation without Workers.
- `packages/domain`: The logic for question generation and grading. It also defines multi-step problems for different grade levels (e.g., addition then subtraction).
- `packages/app`: Manages quiz progression (question order, correct answer count, etc.) using the domain logic.
- `docs/`: Design and operational documents.
- `infra/`: Terraform and D1 migrations.
- `games/math-quiz`: The old browser-based game (static HTML/JS).
- `games/clock-quest`: A prototype ClockQuest trainer with analog & digital clocks (static HTML/JS).

## Related Documents

- `AGENTS.md`: Overall design and module dependencies.
- `docs/local-dev.md`: Procedures for setting up a local validation environment.
- `docs/edu-quest-architecture.md`: Detailed architecture design.
- `docs/math-quiz.md`: Specifications for the old standalone mini-game.
